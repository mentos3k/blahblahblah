<!DOCTYPE html>
<html>
<head>
  <title>Sandbox PoC</title>
</head>
<body>
  <h2>Sandbox PoC - Float Leak + Dummy WASM</h2>
  <canvas id="glcanvas" width="1" height="1"></canvas>
  <pre id="log"></pre>

  <script>
    const log = msg => document.getElementById("log").textContent += msg + "\n";

    const canvas = document.getElementById("glcanvas");
    const gl = canvas.getContext("webgl2");
    if (!gl) {
      log("âŒ WebGL2 not supported");
      throw new Error();
    }
    log("âœ… WebGL2 context acquired");

    // === FLOAT LEAK PoC ===
    const vsSource = `#version 300 es
      in float a;
      out float b;
      void main() { b = a; gl_Position = vec4(0); }
    `;
    const fsSource = `#version 300 es
      precision mediump float;
      out vec4 outColor;
      void main() { outColor = vec4(1.0); }
    `;

    function compileShader(type, src) {
      const s = gl.createShader(type);
      gl.shaderSource(s, src);
      gl.compileShader(s);
      return s;
    }

    const prog = gl.createProgram();
    gl.attachShader(prog, compileShader(gl.VERTEX_SHADER, vsSource));
    gl.attachShader(prog, compileShader(gl.FRAGMENT_SHADER, fsSource));
    gl.transformFeedbackVaryings(prog, ['b'], gl.SEPARATE_ATTRIBS);
    gl.linkProgram(prog);
    gl.useProgram(prog);

    const vertexBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, vertexBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([666.666]), gl.STATIC_DRAW);

    const loc = gl.getAttribLocation(prog, "a");
    gl.enableVertexAttribArray(loc);
    gl.vertexAttribPointer(loc, 1, gl.FLOAT, false, 0, 0);

    const tfb = gl.createBuffer();
    gl.bindBufferBase(gl.TRANSFORM_FEEDBACK_BUFFER, 0, tfb);
    gl.bufferData(gl.TRANSFORM_FEEDBACK_BUFFER, 4, gl.DYNAMIC_COPY);

    gl.enable(gl.RASTERIZER_DISCARD);
    gl.beginTransformFeedback(gl.POINTS);
    gl.drawArrays(gl.POINTS, 0, 1);
    gl.endTransformFeedback();
    gl.disable(gl.RASTERIZER_DISCARD);

    const out = new Float32Array(1);
    gl.getBufferSubData(gl.TRANSFORM_FEEDBACK_BUFFER, 0, out);
    log(`ðŸ“¥ Read back: ${out[0]}`);

    // === DUMMY WASM ===
    const wasmCode = new Uint8Array([
      0x00,0x61,0x73,0x6D, 0x01,0x00,0x00,0x00,
      0x01,0x04,0x01,0x60,0x00,0x00,
      0x03,0x02,0x01,0x00,
      0x07,0x07,0x01,0x03,0x66,0x6F,0x6F,0x00,0x00,
      0x0A,0x04,0x01,0x02,0x00,0x0B
    ]);
    WebAssembly.instantiate(wasmCode).then(res => {
      res.instance.exports.foo();
      log("âœ… Dummy WASM ran");
    });
  </script>
</body>
</html>
